name: Manual Multi-Stage Deployment (ECR + Compose)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

jobs:

# =========================
# 1️⃣ BUILD & PUSH TO ECR
# =========================
  build:
    name: Build & Push to ECR
    runs-on: self-hosted

    outputs:
      image: ${{ steps.image.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          aws ecr get-login-password --region $AWS_REGION \
          | docker login --username AWS --password-stdin \
          $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Build & Push Image (Tag = Build ID)
        id: image
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          IMAGE=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:${{ github.run_number }}

          docker build -t $IMAGE .
          docker push $IMAGE

          echo "image=$IMAGE" >> $GITHUB_OUTPUT


# =========================
# 2️⃣ DEPLOY USING DOCKER COMPOSE
# =========================
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: SSH Deploy via Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          password: ${{ secrets.VM_PASSWORD }}   # ✅ Username + Password login
          script: |

            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_REGION=${{ secrets.AWS_REGION }}

            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

            # Login to ECR
            aws ecr get-login-password --region $AWS_REGION \
            | sudo docker login --username AWS --password-stdin \
            $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

            # Go to project directory (already cloned on VM)
            cd /home/${{ secrets.VM_USER }}/your-project-folder

            # Set image tag dynamically for compose
            export IMAGE_TAG=${{ github.run_number }}

            # Pull latest image
            sudo docker compose pull

            # Restart services
            sudo docker compose down
            sudo docker compose up -d --remove-orphans

            echo "Deployment Completed Successfully"
